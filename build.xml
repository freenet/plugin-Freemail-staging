<?xml version="1.0"?>
<project name="Freemail" default="dist" basedir=".">
	<property file="override.properties"/>
	<property file="build.properties"/>

	<!-- set global properties for this build -->
	<property name="src" location="src"/>
	<property name="test" location="test"/>
	<property name="test.run" location="run"/>
	<property name="build" location="build"/>
	<property name="build-test" location="build-test"/>
	<property name="lib" location="lib"/>
	<property name="dist" location="dist"/>
	<property name="deps" location="deps"/>
	
	<property name="bcdist" value="lcrypto-jdk14-138"/>
	<property name="freenet-cvs-snapshot.location" location="../fred/dist/freenet.jar"/>

	<target name="bouncycastle-check">
		<available file="${deps}/${bcdist}" property="bouncycastle-dist.present" />
		<available file="${build}/org/bouncycastle" property="bouncycastle-bin.present" />
	</target>

	<target name="bouncycastle-fetch" depends="bouncycastle-check" unless="bouncycastle-dist.present">
		<mkdir dir="${deps}" />
		<get src="http://www.bouncycastle.org/download/${bcdist}.zip" 
		dest="${deps}/${bcdist}.zip" 
		verbose="true"
		usetimestamp="true" />

		<unzip src="${deps}/${bcdist}.zip" dest="${deps}" />
	</target>

	<target name="bouncycastle-compile" depends="bouncycastle-fetch" unless="bouncycastle-bin.present">
		<mkdir dir="build" />
		<javac srcdir="${deps}/${bcdist}/src" destdir="${build}" debug="on" optimize="on" source="1.4" nowarn="true">
			<exclude name="**/test/*" />
			<exclude name="org/bouncycastle/util/IPTest.java" />
			<exclude name="org/bouncycastle/util/AllTests.java" />
		</javac>
	</target>

	<target name="compile" depends="bouncycastle-compile">
		<mkdir dir="${build}"/>

		<tstamp/>
		
		<!-- Bundle the whole lot together, unless anyone whinges.
		     It makes it much easier to run -->
		<javac srcdir="${src}" destdir="${build}" debug="on" optimize="on" source="1.4">
			<classpath>
				<pathelement location="${freenet-cvs-snapshot.location}"/>
			</classpath>
		</javac>
		<copy todir="${build}/freemailgui/text">
			<fileset dir="${src}/freemailgui/text" />
		</copy>
		<copy todir="${build}/freemailgui/images">
			<fileset dir="${src}/freemailgui/images" />
	       </copy>
	</target>

	<target name="unit-build" depends="compile" unless="${test.skip}">
		<mkdir dir="${build-test}"/>
		<javac srcdir="${test}" destdir="${build-test}" debug="on" optimize="on" source="1.5" target="1.5">
			<classpath>
				<pathelement location="${freenet-cvs-snapshot.location}"/>
				<pathelement location="${build}"/>
				<pathelement location="${junit}"/>
			</classpath>
			<compilerarg line="-Xlint"/>
		</javac>
	</target>

	<target name="unit" depends="unit-build" unless="${test.skip}">
		<mkdir dir="${test.run}"/>
		<junit printsummary="yes" fork="yes" haltonfailure="yes" dir="${test.run}">
			<classpath>
				<pathelement location="${freenet-cvs-snapshot.location}"/>
				<pathelement path="${build}"/>
				<pathelement path="${build-test}"/>
				<pathelement location="${junit}"/>
			</classpath>
			<formatter type="plain" usefile="false"/>
			<batchtest fork="yes">
				<fileset dir="${build-test}">
					<include name="**/*Test.class"/>
				</fileset>
			</batchtest>
		</junit>
		<delete dir="${test.run}"/>
	</target>

	<target name="dist" depends="compile, unit">
		<mkdir dir="${dist}"/>
		<jar jarfile="${dist}/Freemail.jar" basedir="${build}">
			<manifest>
				<attribute name="Main-Class" value="freemail.FreemailCli"/>
				<attribute name="Plugin-Main-Class" value="freemail.FreemailPlugin"/>
				<attribute name="Built-By" value="${user.name}"/>
				<section name="common">
					<attribute name="Implementation-Title" value="Freemail"/>
					<attribute name="Implementation-Version" value="0.0"/> 
					<attribute name="Implementation-Vendor" value="Dave Baker"/>
				</section>
			</manifest>
		</jar>    
	</target>

	<target name="clean">
		<delete includeEmptyDirs="true">
			<fileset dir="${build}">
				<exclude name="org/bouncycastle/**"/>
			</fileset>
		</delete>
		<delete dir="${build-test}"/>
		<delete dir="${dist}"/>
		<delete dir="${lib}"/>
	</target>

	<target name="cleaner">
		<delete dir="${build}"/>
		<delete dir="${build-test}"/>
		<delete dir="${lib}"/>
	</target>

	<target name="squeakyclean" depends="cleaner">
		<delete dir="${deps}"/>
	</target>

	<target name="distclean" description="Delete everything and restore to the original state.">
		<delete dir="${build}"/>
		<delete dir="${build-test}"/>
		<delete dir="${lib}"/>
		<delete dir="${deps}"/>
	</target>
</project>
